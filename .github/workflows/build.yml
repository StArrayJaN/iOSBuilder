name: Build IPA directly

on:
  push:
  release:
    types: [published, edited]
  workflow_dispatch:

jobs:
  build:
    name: Build and Package IPA
    runs-on: macos-latest
    env:
      scheme: Unity-iPhone          # 根据实际修改
      archive_path: archive

    steps:
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'      # 使用有效版本

      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive

      # 如果需要下载外部工程，取消下面注释
      - name: Run download script
        run: |
          chmod +x ./download.sh
          ./download.sh

      - name: Fix permissions
        run: |
          chmod +x *.sh
          chmod +x usymtool usymtoolarm64 2>/dev/null || true

      - name: Set Scheme
        id: scheme
        run: |
          if [ "${{ env.scheme }}" = "default" ]; then
            scheme_list=$(xcodebuild -list -json | tr -d "\n")
            scheme=$(echo $scheme_list | ruby -e "require 'json'; puts JSON.parse(STDIN.gets)['project']['targets'][0]")
            echo "Using default scheme: $scheme"
          else
            scheme="${{ env.scheme }}"
            echo "Using configured scheme: $scheme"
          fi
          echo "scheme=$scheme" >> $GITHUB_OUTPUT

      - name: Set filetype_parameter
        id: filetype_parameter
        run: |
          if ls -A | grep -i \\.xcworkspace$ >/dev/null; then
            echo "filetype_parameter=workspace" >> $GITHUB_OUTPUT
          else
            echo "filetype_parameter=project" >> $GITHUB_OUTPUT
          fi

      - name: Set file_to_build
        id: file_to_build
        run: |
          file_to_build=$(ls -A | grep -i \\.xcworkspace$ || ls -A | grep -i \\.xcodeproj$ | head -1)
          echo "file_to_build=$file_to_build" >> $GITHUB_OUTPUT

      - name: Build and Archive
        run: |
          xcodebuild clean archive \
            -scheme "${{ steps.scheme.outputs.scheme }}" \
            -"${{ steps.filetype_parameter.outputs.filetype_parameter }}" "${{ steps.file_to_build.outputs.file_to_build }}" \
            -destination "generic/platform=iOS" \
            -sdk iphoneos \
            -configuration Release \
            -archivePath "${{ env.archive_path }}" \
            CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO \
            | xcpretty && exit ${PIPESTATUS[0]}

      - name: Install ldid (for fake-sign)
        run: brew install ldid

      - name: Find .app path
        id: find_app
        run: |
          app_path=$(find "${{ env.archive_path }}.xcarchive" -type d -name "*.app" | head -1)
          if [ -z "$app_path" ]; then
            echo "错误：未找到 .app 文件"
            exit 1
          fi
          echo "app_path=$app_path" >> $GITHUB_OUTPUT

      - name: Fakesign
        run: |
          find "${{ steps.find_app.outputs.app_path }}" -type d -path '*/Frameworks/*.framework' -exec ldid -S \{\} \;
          ldid -S "${{ steps.find_app.outputs.app_path }}"

      - name: Create IPA
        run: |
          app_name=$(basename "${{ steps.find_app.outputs.app_path }}")
          mkdir -p Payload
          cp -r "${{ steps.find_app.outputs.app_path }}" "Payload/$app_name"
          zip -r "${{ steps.scheme.outputs.scheme }}.ipa" Payload -x "._*" -x ".DS_Store" -x "__MACOSX"

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.scheme.outputs.scheme }}.ipa
          path: ${{ steps.scheme.outputs.scheme }}.ipa